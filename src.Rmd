---
title: 'TCC'
author: "Gustavo Theil"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(mapview)
library(rdrobust)
library(units)

mapviewOptions(basemaps = "CartoDB.Positron")
setwd("C:/git/TCC")
```


```{r "dados/eixos", cache = TRUE}
## eixos ----
eixos <- read_sf("dados/PDE/sirgas_PDE_3-Eixos-EETU.shp") |>
  st_set_crs("epsg:31983") |> 
  select(geometry)

eixos.buffersimples <- eixos |> 
  st_buffer(1000) |> 
  st_union() |> 
  st_simplify(dTolerance = 100)

eixos.contorno <- eixos |> 
  st_buffer(50) |> 
  st_union() |> 
  st_buffer(-50) |> 
  nngeo::st_remove_holes() |> 
  st_cast("MULTILINESTRING") |> 
  st_as_sf()

mapview(eixos.contorno) + mapview(eixos)
```


```{r "dados/lotes", cache = TRUE}
IPTU <- read.csv("dados/IPTU/IPTU_2024.csv", sep=";", encoding = "latin1") |>  
    as_tibble() |>  
    select(sql = "NUMERO.DO.CONTRIBUINTE", 
           condominio = "NUMERO.DO.CONDOMINIO",
           area_terreno = "AREA.DO.TERRENO",
           area_construida = "AREA.CONSTRUIDA",
           area_ocupada = "AREA.OCUPADA",
           pavimentos = "QUANTIDADE.DE.PAVIMENTOS",
           ano_construcao = "ANO.DA.CONSTRUCAO.CORRIGIDO",
           tipo = "TIPO.DE.PADRAO.DA.CONSTRUCAO") |>  
    # Separação do número de contribuinte (SQL) em setor quadra e lote
    mutate(setor =  str_sub(sql, 1, 3),
           quadra = str_sub(sql, 4, 6),
           # Quando o lote é um condomínio, haverá vários SQLs no mesmo lote. CD = Condomínio
           lote = str_sub(sql, 7, 10) |>  
             ifelse(condominio == "00-0", yes = _, paste("CD", str_sub(condominio, 1, 2), sep = "")),
           # Tipo de uso
           residencial = str_detect(tipo, "Residencial")) |> 
  # Agregar por SQL
  group_by(setor, quadra, lote) |>  
  summarize(unidades = n(),
            area_terreno = median(area_terreno), 
            area_construida = sum(area_construida), 
            area_ocupada = median(area_ocupada),
            pavimentos = median(pavimentos),
            ano_construcao = median(ano_construcao),
            residencial = median(residencial)) |>  
  ungroup() |>  
  mutate(densidade_construtiva = area_construida / area_terreno,
         densidade_habitacional = unidades / area_terreno,
         verticalizacao = area_construida / area_ocupada)

lotes <- list.files(path="dados/lotes/unzip", full.names = FALSE) |>  
  (\(.) paste("dados/lotes/unzip/", ., "/", ., ".shp", sep = ""))() |>  
  lapply(read_sf) |>  
  bind_rows() |>  
  st_set_crs("epsg:31983") |> 
  filter(lo_tp_lote == "F") |>  # Seleção apenas de lotes fiscais
  mutate(lo_lote = ifelse(lo_lote == "0000", paste("CD", lo_condomi, sep = ""), lo_lote)) |>  
  select(setor = lo_setor, quadra = lo_quadra, lote = lo_lote)
  filter(st_centroid(geometry) |> st_covered_by(eixos.buffersimples) |> as.logical())
  
IPTU.lote <- lotes |>  
  left_join(IPTU, by = join_by(setor, quadra, lote)) |>  
  ungroup()

remove(IPTU, lotes)
```




```{r "dados/censo", cache = TRUE}
censo2010 <- read_sf("dados/censo/2010/35SEE250GC_SIR.shp") |> 
  filter(CD_GEOCODM == "3550308") |> 
  st_transform("epsg:31983") |> 
  select(id_setor = CD_GEOCODI) |> 
  left_join(readxl::read_excel("dados/censo/2010/Basico_SP1.XLS") |> 
              select(id_setor = Cod_setor, moradores = V002) |> 
              mutate(id_setor = as.character(id_setor)),
            by = join_by(id_setor)) |> 
  filter(st_covered_by(geometry, eixos.buffersimples) |> as.logical()) |> 
  mutate(ano = 2010)

censo2022 <- read_sf("dados/censo/2022/SP_Malha_Preliminar_2022.shp") |> 
  filter(CD_MUN == "3550308") |> 
  st_transform("epsg:31983")  |>
  select(id_setor = CD_SETOR, moradores = v0001) |> 
  filter(st_covered_by(geometry, eixos.buffersimples) |> as.logical()) |> 
  mutate(ano = 2022)

censo <- bind_rows(list(censo2010, censo2022)) |> 
  mutate(area = st_area(geometry)) 
```

```{r "dados/tratados/censo", cache = TRUE}
censo <- censo |> 
  st_intersection(IPTU.lote |> st_union()) |> 
  mutate(area_cut = st_area(geometry))
```


```{r "dados/tratados/distancias", cache = TRUE}
zonas <- zonas |> 
  group_by(eixo) |> 
  summarize(geometry = st_union(geometry))

# censo <- censo |> 
#   mutate(distancia_eixo = as.numeric(st_distance(geometry, zonas |> filter( eixo))[,1]),
#          distancia_fora = as.numeric(st_distance(geometry, zonas |> filter(!eixo))[,1]),
#          grupo = case_when(distancia_eixo == 0 & distancia_fora == 0 ~ "Fora",
#                            distancia_eixo != 0 & distancia_fora == 0 ~ "Controle",
#                            distancia_eixo == 0 & distancia_fora != 0 ~ "Tratamento",
#                            TRUE ~ "ERRO"),
#          distancia = case_when(grupo == "Controle"   ~ -distancia_eixo,
#                                grupo == "Tratamento" ~  distancia_fora,
#                                grupo == "Fora"       ~  NA,
#                                TRUE                  ~  NA))



censo <- censo |> 
  mutate(centroid = st_centroid(geometry),
         distancia_eixo = as.numeric(st_distance(centroid, zonas |> filter( eixo))[,1]),
         distancia_fora = as.numeric(st_distance(centroid, zonas |> filter(!eixo))[,1])) |> 
  as_tibble() |> 
  left_join(censo |> 
              st_intersection(eixos |> st_union()) |> 
              select(id_setor, geometry_eixo = geometry) |> 
              as_tibble()) |> 
  mutate(area_eixo = st_area(geometry_eixo),
         percent_eixo = as.numeric(area_eixo / area_cut),
         posicao_centroide = ifelse(distancia_eixo > distancia_fora, "fora", "eixo"))

censo |> 
  st_drop_geometry() |> 
  ggplot(aes(x = posicao_centroide, y = percent_eixo)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = .0, ymax = .05, fill = "darkred", alpha = .05) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = .75, ymax = 1, fill = "darkgreen", alpha = .05) +
  geom_violin(fill = "darkblue") +
  facet_wrap(~ano) +
  geom_hline(yintercept = .75, linetype = "dotted") +
  geom_hline(yintercept = .05, linetype = "dotted") +
  theme_bw() +
  labs(x = "Região mais próxima ao centroide", y = "Percentual da área em eixo")

```

```{r "dados/tratados/grupos", cache = TRUE}
censo <- censo |> 
  mutate(grupo = case_when(posicao_centroide == "eixo" & percent_eixo >= .75 ~ "Tratamento",
                           posicao_centroide == "fora" & percent_eixo <=  .1 ~ "Controle",
                           .default = "Descartado"),
         distancia = case_when(grupo == "Tratamento" ~ distancia_fora,
                               grupo == "Controle" ~  -distancia_eixo,
                               .default = NA))

# distancia = case_when(grupo == "Tratamento" ~ as.numeric(st_distance(geometry |> st_buffer(-20), zonas |> filter(!eixo))[,1]),
#                                grupo == "Controle" ~  -as.numeric(st_distance(geometry |> st_buffer(-20), zonas |> filter( eixo))[,1]),
#                                .default = NA)

mapview(censo |> filter(ano == 2022) |> st_set_geometry("geometry"), zcol = "grupo") + 
  mapview(censo |> filter(ano == 2022) |> st_set_geometry("centroid"), zcol = "grupo") +
  mapview(eixos)
```

```{r}
# censo |> 
#   filter(distancia == 0, ano == 2022) |> 
#   st_set_geometry("geometry") |> 
#   mapview() + mapview(zonas)
```

```{r}
# censo |> 
#   group_by(grupo) |> 
#   summarize(area = mean(area),
#             distancia = mean(distancia))


```


```{r "analise/rdd/graficos", cache = TRUE}
censo |> 
  st_drop_geometry() |>
  filter(ano == 2022, grupo != "Descartado", abs(distancia) < 500) |> 
  mutate(densidade = moradores / as.numeric(area)) |> 
  drop_na() |>
  (\(df) rdplot(as.numeric(df$densidade), df$distancia, 
                binselect = "qs", ci = .99, p = 1, c = 0))(df = _) 

censo |> 
  st_drop_geometry() |>
  filter(ano == 2010, grupo != "Descartado", abs(distancia) < 500) |> 
  mutate(densidade = moradores / as.numeric(area)) |> 
  drop_na() |>
  (\(df) rdplot(as.numeric(df$densidade), df$distancia, 
                binselect = "qs", ci = .99, p = 1, c = 0))(df = _)
```



```{r "analise/rdd/regressao", cache = TRUE}
censo |> 
  st_drop_geometry() |>
  filter(ano == 2022, grupo != "Descartado") |> 
  mutate(densidade = moradores / as.numeric(area)) |> 
  drop_na() |>
  (\(df) rdrobust(as.numeric(df$densidade), df$distancia, 
                  kernel = "tri", p = 1))(df = _) |> 
  summary()

censo |> 
  st_drop_geometry() |>
  filter(ano == 2010, grupo != "Descartado") |> 
  mutate(densidade = moradores / as.numeric(area)) |> 
  drop_na() |>
  (\(df) rdrobust(as.numeric(df$densidade), df$distancia, 
                  kernel = "tri", p = 1))(df = _) |> 
  summary()
```



















